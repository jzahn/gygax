generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model HealthCheck {
  id        String   @id @default(cuid())
  checkedAt DateTime @default(now())
  status    String   @default("ok")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  passwordHash   String
  name           String
  avatarUrl      String?
  emailVerified  Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  passwordResets PasswordReset[]
  adventures     Adventure[]
  campaigns      Campaign[]
  characters     Character[]

  dmSessions        Session[]             @relation("dm_sessions")
  participations    SessionParticipant[]
  campaignMembers   CampaignMember[]
  sessionInvites    SessionInvite[]

  chatMessages            ChatMessage[]
  chatChannelParticipants ChatChannelParticipant[]

  @@map("users")
}

model PasswordReset {
  id        String    @id @default(cuid())
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model Campaign {
  id              String   @id @default(cuid())
  name            String
  description     String?
  bannerImageUrl  String?
  bannerHotspotX  Float?   @default(50)
  bannerHotspotY  Float?   @default(50)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ownerId    String
  owner      User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  adventures Adventure[]
  worldMap   Map?
  members    CampaignMember[]
  mapStates  CampaignMapState[]

  @@map("campaigns")
}

model Adventure {
  id                 String    @id @default(cuid())
  name               String
  description        String?
  coverImageUrl      String?
  coverImageFocusX   Float?
  coverImageFocusY   Float?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  ownerId    String
  owner      User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  maps       Map[]
  npcs       NPC[]
  backdrops  Backdrop[]
  notes      Note[]
  sessions   Session[]
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  mapStates  AdventureMapState[]

  @@index([campaignId])
  @@map("adventures")
}

enum GridType {
  SQUARE
  HEX
}

model Map {
  id          String   @id @default(cuid())
  name        String
  description String?
  gridType    GridType @default(SQUARE)
  width       Int      @default(30)
  height      Int      @default(30)
  cellSize    Int      @default(40)
  content     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  adventureId String?
  adventure   Adventure? @relation(fields: [adventureId], references: [id], onDelete: Cascade)

  campaignId  String?    @unique
  campaign    Campaign?  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  sessionMapStates   SessionMapState[]
  campaignMapStates  CampaignMapState[]
  adventureMapStates AdventureMapState[]

  @@index([adventureId])
  @@map("maps")
}

model Character {
  id               String   @id @default(cuid())
  name             String
  class            String   // Fighter, Magic-User, Cleric, Thief, Elf, Dwarf, Halfling
  level            Int      @default(1)
  alignment        String?  // Lawful, Neutral, Chaotic
  title            String?  // Class-specific title

  // Ability Scores (3-18)
  strength         Int      @default(10)
  intelligence     Int      @default(10)
  wisdom           Int      @default(10)
  dexterity        Int      @default(10)
  constitution     Int      @default(10)
  charisma         Int      @default(10)

  // Combat
  hitPointsMax     Int      @default(1)
  hitPointsCurrent Int      @default(1)
  armorClass       Int      @default(9)  // Unarmored AC in B/X

  // Saving Throws
  saveDeathRay     Int      @default(14)
  saveWands        Int      @default(15)
  saveParalysis    Int      @default(16)
  saveBreath       Int      @default(17)
  saveSpells       Int      @default(17)

  // Resources
  experiencePoints Int      @default(0)
  goldPieces       Int      @default(0)

  // Freeform text fields
  equipment        String?  // Player-written equipment list
  spells           String?  // Player-written spell list

  // Optional
  avatarUrl        String?
  notes            String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  ownerId          String
  owner            User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  participations   SessionParticipant[]

  @@index([ownerId])
  @@map("characters")
}

model NPC {
  id               String   @id @default(cuid())
  name             String
  description      String?  // DM reference: who is this NPC, role, personality

  class            String?  // Optional: Fighter, Magic-User, Cleric, etc.
  level            Int      @default(1)
  alignment        String?  // Lawful, Neutral, Chaotic
  title            String?  // Class-specific title

  // Ability Scores (all optional, default null)
  strength         Int?
  intelligence     Int?
  wisdom           Int?
  dexterity        Int?
  constitution     Int?
  charisma         Int?

  // Combat
  hitPointsMax     Int?
  hitPointsCurrent Int?
  armorClass       Int?

  // Saving Throws (all optional)
  saveDeathRay     Int?
  saveWands        Int?
  saveParalysis    Int?
  saveBreath       Int?
  saveSpells       Int?

  // Resources (optional for NPCs)
  experiencePoints Int?
  goldPieces       Int?

  // Freeform text fields
  equipment        String?
  spells           String?
  notes            String?

  // Avatar
  avatarUrl        String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  adventureId      String
  adventure        Adventure @relation(fields: [adventureId], references: [id], onDelete: Cascade)

  @@index([adventureId])
  @@map("npcs")
}

model Backdrop {
  id          String   @id @default(cuid())
  name        String
  description String?
  imageUrl    String
  focusX      Int      @default(50)
  focusY      Int      @default(50)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  adventureId String
  adventure   Adventure @relation(fields: [adventureId], references: [id], onDelete: Cascade)

  @@index([adventureId])
  @@map("backdrops")
}

model Note {
  id          String   @id @default(cuid())
  title       String
  content     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  adventureId String
  adventure   Adventure @relation(fields: [adventureId], references: [id], onDelete: Cascade)

  @@index([adventureId])
  @@map("notes")
}

enum SessionStatus {
  FORMING  // DM is gathering players, session visible in browse lists
  ACTIVE   // Session is live, removed from browse lists
  PAUSED   // Session paused mid-game
  ENDED    // Session complete
}

enum SessionAccessType {
  OPEN      // Anyone can browse and join
  CAMPAIGN  // Campaign members have automatic access
  INVITE    // DM explicitly invites specific players
}

model Session {
  id          String            @id @default(cuid())
  status      SessionStatus     @default(FORMING)
  accessType  SessionAccessType @default(OPEN)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  startedAt   DateTime?         // When DM started the session (FORMING â†’ ACTIVE)
  pausedAt    DateTime?
  endedAt     DateTime?

  adventureId String
  adventure   Adventure     @relation(fields: [adventureId], references: [id], onDelete: Cascade)

  dmId        String
  dm          User          @relation("dm_sessions", fields: [dmId], references: [id], onDelete: Cascade)

  // Current display state
  activeMapId      String?
  activeBackdropId String?

  participants SessionParticipant[]
  invites      SessionInvite[]
  chatChannels ChatChannel[]
  mapStates    SessionMapState[]
  tokens       SessionToken[]

  @@index([adventureId])
  @@index([dmId])
  @@index([status])
  @@index([accessType])
  @@map("sessions")
}

model SessionParticipant {
  id        String   @id @default(cuid())
  joinedAt  DateTime @default(now())
  leftAt    DateTime?

  sessionId   String
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("session_participants")
}

model CampaignMember {
  id         String   @id @default(cuid())
  joinedAt   DateTime @default(now())

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campaignId, userId])
  @@index([campaignId])
  @@index([userId])
  @@map("campaign_members")
}

model SessionInvite {
  id         String    @id @default(cuid())
  createdAt  DateTime  @default(now())
  acceptedAt DateTime?
  declinedAt DateTime?

  sessionId  String
  session    Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  userId     String?   // Existing user (if known)
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  email      String?   // Or invite by email (for users not yet registered)

  @@unique([sessionId, userId])
  @@unique([sessionId, email])
  @@index([sessionId])
  @@index([userId])
  @@index([email])
  @@map("session_invites")
}

// Chat models

model ChatChannel {
  id        String   @id @default(cuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  name      String?  // null for 1:1 channels, user-defined for groups
  isMain    Boolean  @default(false) // The main channel includes everyone
  createdAt DateTime @default(now())

  participants ChatChannelParticipant[]
  messages     ChatMessage[]

  @@index([sessionId])
  @@map("chat_channels")
}

model ChatChannelParticipant {
  id        String      @id @default(cuid())
  channelId String
  channel   ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt  DateTime    @default(now())

  // Track unread state per user per channel
  lastReadAt DateTime   @default(now())

  @@unique([channelId, userId])
  @@map("chat_channel_participants")
}

enum ChatMessageType {
  TEXT       // Regular text message
  ROLL       // Dice roll result
  SYSTEM     // System message (player joined, session paused, etc.)
}

// Token types for session map
enum SessionTokenType {
  PC        // Player character
  NPC       // Friendly or neutral NPC
  MONSTER   // Hostile creature
}

model ChatMessage {
  id        String          @id @default(cuid())
  content   String          // Raw message text (or dice command)
  type      ChatMessageType @default(TEXT)
  createdAt DateTime        @default(now())

  channelId String
  channel   ChatChannel     @relation(fields: [channelId], references: [id], onDelete: Cascade)

  senderId  String
  sender    User            @relation(fields: [senderId], references: [id], onDelete: Cascade)

  // Dice roll results (populated when type is ROLL)
  diceExpression String?    // e.g., "3d6+1"
  diceRolls      Json?      // e.g., [4, 2, 6]
  diceTotal      Int?       // e.g., 13 (sum + modifier)
  diceModifier   Int?       // e.g., 1

  @@index([channelId, createdAt])
  @@map("chat_messages")
}

// Fog of war state per map in a session
model SessionMapState {
  id        String   @id @default(cuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  mapId     String
  map       Map      @relation(fields: [mapId], references: [id], onDelete: Cascade)

  // Fog state: list of revealed cells/hexes
  // Square grid: [{col: number, row: number}, ...]
  // Hex grid: [{q: number, r: number}, ...] (axial coordinates)
  revealedCells Json   @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, mapId])
  @@index([sessionId])
  @@index([mapId])
  @@map("session_map_states")
}

// Fog of war state for campaign world maps (persists across all sessions)
model CampaignMapState {
  id         String   @id @default(cuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  mapId      String
  map        Map      @relation(fields: [mapId], references: [id], onDelete: Cascade)

  // Fog state: list of revealed cells/hexes (same format as SessionMapState)
  revealedCells Json   @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([campaignId, mapId])
  @@index([campaignId])
  @@index([mapId])
  @@map("campaign_map_states")
}

// Fog of war state for adventure maps (persists across all sessions in the adventure)
model AdventureMapState {
  id          String    @id @default(cuid())
  adventureId String
  adventure   Adventure @relation(fields: [adventureId], references: [id], onDelete: Cascade)
  mapId       String
  map         Map       @relation(fields: [mapId], references: [id], onDelete: Cascade)

  // Fog state: list of revealed cells/hexes (same format as SessionMapState)
  revealedCells Json   @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([adventureId, mapId])
  @@index([adventureId])
  @@index([mapId])
  @@map("adventure_map_states")
}

// Tokens on maps during sessions
model SessionToken {
  id        String   @id @default(cuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Position
  mapId     String   // Which map the token is on
  position  Json     // {col, row} for square, {q, r} for hex

  // Token identity
  type      SessionTokenType
  name      String
  imageUrl  String?

  // Optional link to character/NPC
  characterId String?
  npcId       String?

  // Visual
  color     String   @default("#666666")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId, mapId])
  @@map("session_tokens")
}

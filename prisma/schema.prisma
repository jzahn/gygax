generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model HealthCheck {
  id        String   @id @default(cuid())
  checkedAt DateTime @default(now())
  status    String   @default("ok")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  passwordHash   String
  name           String
  avatarUrl      String?
  emailVerified  Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  passwordResets PasswordReset[]
  adventures     Adventure[]
  campaigns      Campaign[]
  characters     Character[]

  dmSessions        Session[]             @relation("dm_sessions")
  participations    SessionParticipant[]
  campaignMembers   CampaignMember[]
  sessionInvites    SessionInvite[]

  @@map("users")
}

model PasswordReset {
  id        String    @id @default(cuid())
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model Campaign {
  id              String   @id @default(cuid())
  name            String
  description     String?
  bannerImageUrl  String?
  bannerHotspotX  Float?   @default(50)
  bannerHotspotY  Float?   @default(50)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ownerId    String
  owner      User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  adventures Adventure[]
  worldMap   Map?
  members    CampaignMember[]

  @@map("campaigns")
}

model Adventure {
  id                 String    @id @default(cuid())
  name               String
  description        String?
  coverImageUrl      String?
  coverImageFocusX   Float?
  coverImageFocusY   Float?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  ownerId    String
  owner      User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  maps       Map[]
  npcs       NPC[]
  backdrops  Backdrop[]
  notes      Note[]
  sessions   Session[]
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@map("adventures")
}

enum GridType {
  SQUARE
  HEX
}

model Map {
  id          String   @id @default(cuid())
  name        String
  description String?
  gridType    GridType @default(SQUARE)
  width       Int      @default(30)
  height      Int      @default(30)
  cellSize    Int      @default(40)
  content     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  adventureId String?
  adventure   Adventure? @relation(fields: [adventureId], references: [id], onDelete: Cascade)

  campaignId  String?    @unique
  campaign    Campaign?  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([adventureId])
  @@map("maps")
}

model Character {
  id               String   @id @default(cuid())
  name             String
  class            String   // Fighter, Magic-User, Cleric, Thief, Elf, Dwarf, Halfling
  level            Int      @default(1)
  alignment        String?  // Lawful, Neutral, Chaotic
  title            String?  // Class-specific title

  // Ability Scores (3-18)
  strength         Int      @default(10)
  intelligence     Int      @default(10)
  wisdom           Int      @default(10)
  dexterity        Int      @default(10)
  constitution     Int      @default(10)
  charisma         Int      @default(10)

  // Combat
  hitPointsMax     Int      @default(1)
  hitPointsCurrent Int      @default(1)
  armorClass       Int      @default(9)  // Unarmored AC in B/X

  // Saving Throws
  saveDeathRay     Int      @default(14)
  saveWands        Int      @default(15)
  saveParalysis    Int      @default(16)
  saveBreath       Int      @default(17)
  saveSpells       Int      @default(17)

  // Resources
  experiencePoints Int      @default(0)
  goldPieces       Int      @default(0)

  // Freeform text fields
  equipment        String?  // Player-written equipment list
  spells           String?  // Player-written spell list

  // Optional
  avatarUrl        String?
  notes            String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  ownerId          String
  owner            User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  participations   SessionParticipant[]

  @@index([ownerId])
  @@map("characters")
}

model NPC {
  id               String   @id @default(cuid())
  name             String
  description      String?  // DM reference: who is this NPC, role, personality

  class            String?  // Optional: Fighter, Magic-User, Cleric, etc.
  level            Int      @default(1)
  alignment        String?  // Lawful, Neutral, Chaotic
  title            String?  // Class-specific title

  // Ability Scores (all optional, default null)
  strength         Int?
  intelligence     Int?
  wisdom           Int?
  dexterity        Int?
  constitution     Int?
  charisma         Int?

  // Combat
  hitPointsMax     Int?
  hitPointsCurrent Int?
  armorClass       Int?

  // Saving Throws (all optional)
  saveDeathRay     Int?
  saveWands        Int?
  saveParalysis    Int?
  saveBreath       Int?
  saveSpells       Int?

  // Resources (optional for NPCs)
  experiencePoints Int?
  goldPieces       Int?

  // Freeform text fields
  equipment        String?
  spells           String?
  notes            String?

  // Avatar
  avatarUrl        String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  adventureId      String
  adventure        Adventure @relation(fields: [adventureId], references: [id], onDelete: Cascade)

  @@index([adventureId])
  @@map("npcs")
}

model Backdrop {
  id          String   @id @default(cuid())
  name        String
  title       String?
  titleX      Int      @default(50)
  titleY      Int      @default(50)
  description String?
  imageUrl    String
  focusX      Int      @default(50)
  focusY      Int      @default(50)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  adventureId String
  adventure   Adventure @relation(fields: [adventureId], references: [id], onDelete: Cascade)

  @@index([adventureId])
  @@map("backdrops")
}

model Note {
  id          String   @id @default(cuid())
  title       String
  content     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  adventureId String
  adventure   Adventure @relation(fields: [adventureId], references: [id], onDelete: Cascade)

  @@index([adventureId])
  @@map("notes")
}

enum SessionStatus {
  FORMING  // DM is gathering players, session visible in browse lists
  ACTIVE   // Session is live, removed from browse lists
  PAUSED   // Session paused mid-game
  ENDED    // Session complete
}

enum SessionAccessType {
  OPEN      // Anyone can browse and join
  CAMPAIGN  // Campaign members have automatic access
  INVITE    // DM explicitly invites specific players
}

model Session {
  id          String            @id @default(cuid())
  status      SessionStatus     @default(FORMING)
  accessType  SessionAccessType @default(OPEN)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  startedAt   DateTime?         // When DM started the session (FORMING â†’ ACTIVE)
  pausedAt    DateTime?
  endedAt     DateTime?

  adventureId String
  adventure   Adventure     @relation(fields: [adventureId], references: [id], onDelete: Cascade)

  dmId        String
  dm          User          @relation("dm_sessions", fields: [dmId], references: [id], onDelete: Cascade)

  // Current display state
  activeMapId      String?
  activeBackdropId String?

  participants SessionParticipant[]
  invites      SessionInvite[]

  @@index([adventureId])
  @@index([dmId])
  @@index([status])
  @@index([accessType])
  @@map("sessions")
}

model SessionParticipant {
  id        String   @id @default(cuid())
  joinedAt  DateTime @default(now())
  leftAt    DateTime?

  sessionId   String
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("session_participants")
}

model CampaignMember {
  id         String   @id @default(cuid())
  joinedAt   DateTime @default(now())

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campaignId, userId])
  @@index([campaignId])
  @@index([userId])
  @@map("campaign_members")
}

model SessionInvite {
  id         String    @id @default(cuid())
  createdAt  DateTime  @default(now())
  acceptedAt DateTime?
  declinedAt DateTime?

  sessionId  String
  session    Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  userId     String?   // Existing user (if known)
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  email      String?   // Or invite by email (for users not yet registered)

  @@unique([sessionId, userId])
  @@unique([sessionId, email])
  @@index([sessionId])
  @@index([userId])
  @@index([email])
  @@map("session_invites")
}
